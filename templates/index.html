<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Stats Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js -->
</head>
<body>
    <div class="container">
        <h1>YouTube Stats Dashboard</h1>
        <button id="refresh">Refresh Data</button>

        <!-- Summary Cards -->
        <div class="summary">
            <div class="card">
                <h3>Total Subscribers</h3>
                <p id="totalSubscribers">Loading...</p>
            </div>
            <div class="card">
                <h3>Total Views</h3>
                <p id="totalViews">Loading...</p>
            </div>
            <div class="card">
                <h3>Total Videos</h3>
                <p id="totalVideos">Loading...</p>
            </div>
        </div>

        <!-- Table Data -->
        <table>
            <thead>
                <tr>
                    <th>Channel</th>
                    <th>Subscribers</th>
                    <th>Views</th>
                    <th>Videos</th>
                </tr>
            </thead>
            <tbody id="channelData">
                <tr><td colspan="4">Loading...</td></tr>
            </tbody>
        </table>

        <!-- Bar Chart (Comparison) -->
        <h2>Subscribers Comparison</h2>
        <canvas id="subscribersChart"></canvas>

        <!-- Line Chart (Growth Trends) -->
        <h2>Growth Trends</h2>
        <canvas id="growthChart"></canvas>

    </div>

    <script>
    let subscribersChartInstance = null;
    let growthChartInstance = null;

    function loadData() {
        $.get("/data", function(data) {  
            let tableBody = $("#channelData");
            tableBody.empty();

            let totalSubscribers = data.totalSubscribers;
            let totalViews = data.totalViews;
            let totalVideos = data.totalVideos;

            let labels = [];
            let subscribersData = [];
            let viewsData = [];

            if (!data.channels || data.channels.length === 0) {
                tableBody.append("<tr><td colspan='4'>No data available.</td></tr>");
            } else {
                data.channels.forEach(channel => {
                    labels.push(channel["Title"]);
                    subscribersData.push(parseInt(channel["Subscribers"]));
                    viewsData.push(parseInt(channel["Views"]));

                    tableBody.append(`<tr>
                        <td>${channel["Title"]}</td>
                        <td>${channel["Subscribers"]}</td>
                        <td>${channel["Views"]}</td>
                        <td>${channel["Videos"]}</td>
                    </tr>`);
                });

                // Update Summary Cards
                $("#totalSubscribers").text(totalSubscribers.toLocaleString());
                $("#totalViews").text(totalViews.toLocaleString());
                $("#totalVideos").text(totalVideos.toLocaleString());

                // Render Charts
                renderBarChart(labels, subscribersData);
                renderLineChart(labels, viewsData);
            }
        });
    }

    // âœ… Destroy existing charts before re-rendering
    function renderBarChart(labels, data) {
        if (subscribersChartInstance) {
            subscribersChartInstance.destroy();
        }
        subscribersChartInstance = new Chart(document.getElementById("subscribersChart"), {
            type: "bar",
            data: {
                labels: labels,
                datasets: [{
                    label: "Subscribers",
                    data: data,
                    backgroundColor: "rgba(75, 192, 192, 0.6)"
                }]
            }
        });
    }

    function renderLineChart(labels, data) {
        if (growthChartInstance) {
            growthChartInstance.destroy();
        }
        growthChartInstance = new Chart(document.getElementById("growthChart"), {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: "Views Growth",
                    data: data,
                    borderColor: "rgba(255, 99, 132, 1)",
                    backgroundColor: "rgba(255, 99, 132, 0.2)",
                    fill: true
                }]
            }
        });
    }

   $("#refresh").click(function() {
    alert("Data update started! Refresh in a few seconds.");
    
    $.ajax({
        url: "/update",
        type: "POST",
        contentType: "application/json",
        success: function(response) {
            console.log(response.message);
        },
        error: function(xhr) {
            alert("Error updating data: " + xhr.responseText);
        }
    });
});


    $(document).ready(loadData);
</script>
    <script>
    function checkUpdateStatus() {
        $.get("/update_status", function(status) {
            $("#updateMessage").text(status.message);
            $("#updateProgress").text(status.progress + "%");

            if (status.updating) {
                $("#refresh").prop("disabled", true);
            } else {
                $("#refresh").prop("disabled", false);
            }
        });
    }

    $("#refresh").click(function() {
        alert("Data update started! You will see progress below.");
        
        $.ajax({
            url: "/update",
            type: "POST",
            contentType: "application/json",
            success: function(response) {
                console.log(response.message);
                checkUpdateStatus();  // Immediately check status
            },
            error: function(xhr) {
                alert("Error updating data: " + xhr.responseText);
            }
        });
    });

    setInterval(checkUpdateStatus, 2000); // Poll every 2 seconds
</script>

<p id="updateMessage">Idle</p>
<p id="updateProgress">0%</p>



</body>
</html>
